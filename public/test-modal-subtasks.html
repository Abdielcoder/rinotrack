<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Modal Subtareas - RinoTrack</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f7fa;
            margin: 0;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .demo-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .title {
            color: #1f2937;
            margin-bottom: 30px;
            text-align: center;
        }
        .btn-demo {
            background: #3b82f6;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        .btn-demo:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .demo-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }
        .form-group input, .form-group select {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .checkbox-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .result {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        /* Estilos del modal copiados del clan leader */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-large {
            max-width: 800px;
        }

        .modal-header {
            padding: 20px 24px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .modal-body {
            padding: 0 24px;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 20px;
        }

        .task-info h4 {
            margin: 0 0 8px 0;
            color: #1f2937;
            font-size: 1.1rem;
        }

        .subtasks-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .subtasks-header span {
            color: #6b7280;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-add-more {
            background: #10b981;
            color: white;
        }

        .btn-add-more:hover {
            background: #059669;
        }

        .subtasks-list {
            min-height: 100px;
        }

        .subtasks-empty {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
            font-style: italic;
        }

        .subtask-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            transition: all 0.2s ease;
        }

        .subtask-item:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .subtask-counter {
            background: #3b82f6;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .subtask-drag-handle {
            color: #9ca3af;
            cursor: grab;
            flex-shrink: 0;
        }

        .subtask-drag-handle:active {
            cursor: grabbing;
        }

        .subtask-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .subtask-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .subtask-remove {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .subtask-remove:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .btn-loader {
            display: inline-flex;
            align-items: center;
        }

        .btn-loader i {
            margin-right: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="demo-card">
            <h1 class="title">ðŸ§ª Test Modal de Subtareas - Clan Leader</h1>
            
            <div class="demo-form">
                <div class="form-group">
                    <label>TÃ­tulo de la tarea:</label>
                    <input type="text" id="task_title" value="Tarea de prueba con modal">
                </div>
                
                <div class="form-group">
                    <label>Fecha lÃ­mite:</label>
                    <input type="date" id="task_due_date" value="2024-12-31">
                </div>
                
                <div class="form-group">
                    <label>Proyecto:</label>
                    <select id="task_project">
                        <option value="29">Proyecto Demo (ID: 29)</option>
                        <option value="30">Proyecto Test (ID: 30)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>DescripciÃ³n:</label>
                    <input type="text" id="task_description" value="DescripciÃ³n de prueba">
                </div>
            </div>
            
            <div class="form-group">
                <label>Colaboradores asignados:</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="member1" name="assigned_members[]" value="1" checked>
                        <label for="member1">Usuario 1</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="member2" name="assigned_members[]" value="2" checked>
                        <label for="member2">Usuario 2</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="member3" name="assigned_members[]" value="3">
                        <label for="member3">Usuario 3</label>
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin: 30px 0;">
                <button class="btn-demo" onclick="openSubtasksModal()">
                    <i class="fas fa-tasks"></i>
                    Abrir Modal de Subtareas
                </button>
                <button class="btn-demo" onclick="testFormData()">
                    <i class="fas fa-code"></i>
                    Test FormData
                </button>
                <button class="btn-demo" onclick="simulateSubmit()">
                    <i class="fas fa-rocket"></i>
                    Simular EnvÃ­o
                </button>
            </div>
            
            <div id="result" class="result">
                Resultados aparecerÃ¡n aquÃ­...
            </div>
        </div>
    </div>

    <!-- Modal para aÃ±adir subtareas -->
    <div id="addSubtasksModal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3 id="addSubtasksModalTitle">
                    <i class="fas fa-tasks" style="margin-right: 8px; color: #3b82f6;"></i>
                    AÃ±adir Subtareas
                </h3>
                <button class="modal-close" onclick="closeAddSubtasksModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="addSubtasksForm">
                <div class="modal-body">
                    <div class="task-info">
                        <h4 id="addSubtasksTaskName">Esta tarea serÃ¡ creada con las subtareas que agregues</h4>
                        <input type="hidden" id="addSubtasksTaskId" name="taskId">
                    </div>
                    
                    <div class="subtasks-container">
                        <div class="subtasks-header">
                            <span>Organiza esta tarea en pasos mÃ¡s pequeÃ±os</span>
                            <button type="button" class="btn btn-small btn-add-more" id="addSubtaskBtnModal">
                                <i class="fas fa-plus"></i> Agregar Subtarea
                            </button>
                        </div>
                        <div id="addSubtasksList" class="subtasks-list">
                            <!-- Las subtareas se agregarÃ¡n aquÃ­ dinÃ¡micamente -->
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeAddSubtasksModal()">
                        Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" id="continueWithSubtasksBtn">
                        <span id="continueSubtasksText">Continuar con Subtareas</span>
                        <span id="continueSubtasksLoader" class="btn-loader" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i>
                        </span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let addSubtaskCounter = 0;

        // FunciÃ³n para mostrar resultados
        function updateResult(content) {
            document.getElementById('result').textContent = content;
        }

        // Modal functions (copiadas del clan leader)
        function openSubtasksModal() {
            const taskTitle = document.getElementById('task_title').value;
            const taskDueDate = document.getElementById('task_due_date').value;
            const assignedMembers = document.querySelectorAll('input[name="assigned_members[]"]:checked');
            
            if (!taskTitle || !taskDueDate) {
                updateResult('âŒ Error: Por favor completa el tÃ­tulo y fecha lÃ­mite antes de agregar subtareas');
                return;
            }
            
            if (assignedMembers.length === 0) {
                updateResult('âŒ Error: Debes asignar al menos un colaborador antes de agregar subtareas');
                return;
            }
            
            const modal = document.getElementById('addSubtasksModal');
            const taskNameEl = document.getElementById('addSubtasksTaskName');
            const listEl = document.getElementById('addSubtasksList');
            
            taskNameEl.textContent = `Tarea: ${taskTitle}`;
            
            listEl.innerHTML = '';
            addSubtaskCounter = 0;
            updateAddSubtasksDisplay();
            
            addSubtaskToForm();
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            
            updateResult('âœ… Modal abierto correctamente. Agrega algunas subtareas y prueba la funcionalidad.');
        }

        function closeAddSubtasksModal() {
            const modal = document.getElementById('addSubtasksModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                
                const listEl = document.getElementById('addSubtasksList');
                if (listEl) {
                    listEl.innerHTML = '';
                    addSubtaskCounter = 0;
                }
            }, 300);
            
            updateResult('Modal cerrado.');
        }

        function addSubtaskToForm() {
            addSubtaskCounter++;
            const subtaskId = 'add_subtask_' + addSubtaskCounter;
            const listEl = document.getElementById('addSubtasksList');
            
            const subtaskItem = document.createElement('div');
            subtaskItem.className = 'subtask-item';
            subtaskItem.dataset.subtaskId = subtaskId;
            
            subtaskItem.innerHTML = `
                <span class="subtask-counter">${addSubtaskCounter}</span>
                <i class="fas fa-grip-vertical subtask-drag-handle" title="Arrastrar para reordenar"></i>
                <input type="text" class="subtask-input" name="subtasks[]" placeholder="Nombre de la subtarea..." required>
                <button type="button" class="subtask-remove" onclick="removeSubtaskFromForm('${subtaskId}')" title="Eliminar subtarea">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            if (listEl) {
                listEl.appendChild(subtaskItem);
                updateAddSubtasksDisplay();
                
                const input = subtaskItem.querySelector('.subtask-input');
                if (input) {
                    input.focus();
                }
            }
        }

        function removeSubtaskFromForm(subtaskId) {
            const subtaskItem = document.querySelector(`[data-subtask-id="${subtaskId}"]`);
            if (subtaskItem) {
                subtaskItem.remove();
                updateAddSubtasksDisplay();
                renumberAddSubtasks();
            }
        }

        function updateAddSubtasksDisplay() {
            const listEl = document.getElementById('addSubtasksList');
            const subtaskItems = listEl ? listEl.querySelectorAll('.subtask-item') : [];
            
            if (subtaskItems.length === 0 && listEl) {
                listEl.innerHTML = '<div class="subtasks-empty">No hay subtareas. Haz clic en "Agregar Subtarea" para comenzar.</div>';
            } else if (listEl && listEl.querySelector('.subtasks-empty')) {
                listEl.querySelector('.subtasks-empty').remove();
            }
        }

        function renumberAddSubtasks() {
            const subtaskItems = document.querySelectorAll('#addSubtasksList .subtask-item');
            subtaskItems.forEach((item, index) => {
                const counter = item.querySelector('.subtask-counter');
                if (counter) {
                    counter.textContent = index + 1;
                }
            });
            addSubtaskCounter = subtaskItems.length;
        }

        function saveTaskWithSubtasks() {
            const subtaskInputs = document.querySelectorAll('#addSubtasksList .subtask-input');
            const subtasks = [];
            
            subtaskInputs.forEach(input => {
                const title = input.value.trim();
                if (title) {
                    subtasks.push({
                        title: title,
                        description: '',
                        completion_percentage: 0,
                        due_date: null,
                        priority: 'medium',
                        assigned_to_user_id: null
                    });
                }
            });
            
            if (subtasks.length === 0) {
                updateResult('âŒ Error: Debes agregar al menos una subtarea');
                return;
            }
            
            updateResult(`âœ… Datos recopilados exitosamente:\n\nSubtareas: ${subtasks.length}\n\n${JSON.stringify(subtasks, null, 2)}`);
            
            // Simular envÃ­o
            setTimeout(() => {
                updateResult(`ðŸš€ Simulando envÃ­o al servidor...\n\nTarea: ${document.getElementById('task_title').value}\nFecha: ${document.getElementById('task_due_date').value}\nSubtareas: ${subtasks.length}\n\nâœ… Â¡Tarea con subtareas creada exitosamente!`);
                closeAddSubtasksModal();
            }, 1500);
        }

        function testFormData() {
            const formData = new FormData();
            
            formData.append('task_title', document.getElementById('task_title').value);
            formData.append('task_due_date', document.getElementById('task_due_date').value);
            formData.append('task_project', document.getElementById('task_project').value);
            formData.append('task_description', document.getElementById('task_description').value);
            
            const assignedMembers = document.querySelectorAll('input[name="assigned_members[]"]:checked');
            assignedMembers.forEach(member => {
                formData.append('assigned_members[]', member.value);
            });
            
            const subtasks = [
                {
                    title: "Subtarea de ejemplo 1",
                    description: "",
                    completion_percentage: 0,
                    due_date: null,
                    priority: "medium",
                    assigned_to_user_id: null
                },
                {
                    title: "Subtarea de ejemplo 2",
                    description: "",
                    completion_percentage: 0,
                    due_date: null,
                    priority: "medium",
                    assigned_to_user_id: null
                }
            ];
            
            formData.append('subtasks', JSON.stringify(subtasks));
            
            let result = 'ðŸ“‹ FormData generado:\n\n';
            for (let [key, value] of formData.entries()) {
                result += `${key}: ${value}\n`;
            }
            
            updateResult(result);
        }

        function simulateSubmit() {
            updateResult('ðŸš€ Simulando envÃ­o a: ?route=clan_leader/create-task\n\nEsto funcionarÃ­a en el entorno real de RinoTrack.\n\nâœ… Test completado exitosamente.');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const addSubtaskBtn = document.getElementById('addSubtaskBtnModal');
            if (addSubtaskBtn) {
                addSubtaskBtn.addEventListener('click', addSubtaskToForm);
            }
            
            const continueBtn = document.getElementById('continueWithSubtasksBtn');
            if (continueBtn) {
                continueBtn.addEventListener('click', saveTaskWithSubtasks);
            }
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('addSubtasksModal');
                    if (modal && modal.style.display !== 'none') {
                        closeAddSubtasksModal();
                    }
                }
            });
            
            updateResult('ðŸš€ Test Modal de Subtareas cargado.\n\nEste test simula la funcionalidad del modal de subtareas del clan leader.\n\n1. Completa los datos de la tarea\n2. Selecciona colaboradores\n3. Haz clic en "Abrir Modal de Subtareas"\n4. Agrega algunas subtareas\n5. Haz clic en "Continuar con Subtareas"');
        });
    </script>
</body>
</html>
