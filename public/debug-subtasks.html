<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Subtareas</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .subtask-item { border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        .form-group { margin: 10px 0; }
        label { display: block; margin-bottom: 5px; }
        input, textarea { width: 100%; padding: 5px; }
        button { padding: 10px 20px; margin: 5px; }
        #debug-output { background: #f0f0f0; padding: 10px; margin: 20px 0; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ” Debug de Subtareas</h1>
    
    <div>
        <button onclick="addSubtask()">â• Agregar Subtarea</button>
        <button onclick="testCollectData()">ğŸ§ª Probar RecolecciÃ³n</button>
        <button onclick="testSendToServer()">ğŸ“¡ Probar EnvÃ­o</button>
    </div>
    
    <div id="subtasks-container">
        <!-- Las subtareas se agregarÃ¡n aquÃ­ -->
    </div>
    
    <div id="debug-output">
        <strong>Debug Output:</strong>
        <br>Haz clic en "Probar RecolecciÃ³n" para ver los datos
    </div>
    
    <!-- Template para subtareas -->
    <template id="subtask-template">
        <div class="subtask-item" data-subtask-index="{index}">
            <div class="form-group">
                <label>TÃ­tulo: <input type="text" name="subtasks[{index}][title]" placeholder="TÃ­tulo de la subtarea"></label>
            </div>
            <div class="form-group">
                <label>Porcentaje: <input type="number" name="subtasks[{index}][percentage]" placeholder="25" min="0" max="100"></label>
            </div>
            <div class="form-group">
                <label>DescripciÃ³n: <textarea name="subtasks[{index}][description]" placeholder="DescripciÃ³n"></textarea></label>
            </div>
            <button onclick="removeSubtask({index})">ğŸ—‘ï¸ Eliminar</button>
        </div>
    </template>
    
    <script>
        let subtaskCounter = 0;
        
        function addSubtask() {
            console.log('ğŸš€ Agregando subtarea...');
            
            const container = document.getElementById('subtasks-container');
            const template = document.getElementById('subtask-template');
            
            if (!container || !template) {
                console.error('âŒ No se encontrÃ³ container o template');
                return;
            }
            
            const subtaskHtml = template.innerHTML
                .replace(/{index}/g, subtaskCounter)
                .replace(/{number}/g, subtaskCounter + 1);
            
            const subtaskElement = document.createElement('div');
            subtaskElement.innerHTML = subtaskHtml;
            
            container.appendChild(subtaskElement.firstElementChild);
            subtaskCounter++;
            
            console.log('âœ… Subtarea agregada. Total:', container.querySelectorAll('.subtask-item').length);
        }
        
        function removeSubtask(index) {
            const element = document.querySelector(`[data-subtask-index="${index}"]`);
            if (element) {
                element.remove();
                console.log('ğŸ—‘ï¸ Subtarea removida:', index);
            }
        }
        
        function testCollectData() {
            console.log('ğŸ§ª === PROBANDO RECOLECCIÃ“N DE DATOS ===');
            
            const subtaskElements = document.querySelectorAll('.subtask-item');
            console.log('ğŸ“Š Elementos encontrados:', subtaskElements.length);
            
            const subtasks = [];
            
            subtaskElements.forEach((element, index) => {
                console.log(`ğŸ”„ Procesando subtarea ${index + 1}:`, element);
                
                const titleInput = element.querySelector('input[name^="subtasks"][name$="[title]"]');
                const percentageInput = element.querySelector('input[name^="subtasks"][name$="[percentage]"]');
                const descriptionInput = element.querySelector('textarea[name^="subtasks"][name$="[description]"]');
                
                console.log(`ğŸ“ Inputs para subtarea ${index + 1}:`, {
                    title: titleInput,
                    percentage: percentageInput,
                    description: descriptionInput
                });
                
                if (titleInput && percentageInput) {
                    const title = titleInput.value.trim();
                    const percentage = percentageInput.value.trim();
                    const description = descriptionInput ? descriptionInput.value.trim() : '';
                    
                    console.log(`ğŸ“‹ Valores de subtarea ${index + 1}:`, { title, percentage, description });
                    
                    if (title && percentage) {
                        subtasks.push({
                            title: title,
                            percentage: parseInt(percentage) || 0,
                            description: description
                        });
                        console.log(`âœ… Subtarea ${index + 1} agregada al array`);
                    } else {
                        console.log(`âš ï¸ Subtarea ${index + 1} sin tÃ­tulo o porcentaje`);
                    }
                } else {
                    console.log(`âŒ No se encontraron inputs para subtarea ${index + 1}`);
                }
            });
            
            console.log('ğŸ“Š Array final de subtareas:', subtasks);
            
            // Mostrar en pantalla
            const debugOutput = document.getElementById('debug-output');
            debugOutput.innerHTML = `
                <strong>Debug Output:</strong>
                <br>Elementos encontrados: ${subtaskElements.length}
                <br>Subtareas recolectadas: ${subtasks.length}
                <br>Array de subtareas: ${JSON.stringify(subtasks, null, 2)}
            `;
            
            return subtasks;
        }
        
        function testSendToServer() {
            console.log('ğŸ“¡ === PROBANDO ENVÃO AL SERVIDOR ===');
            
            const subtasks = testCollectData();
            
            if (subtasks.length === 0) {
                console.log('âš ï¸ No hay subtareas para enviar');
                return;
            }
            
            // Crear FormData
            const formData = new FormData();
            formData.append('task_title', 'Tarea de prueba');
            formData.append('task_due_date', '2024-12-31');
            formData.append('task_project', '29');
            formData.append('subtasks', JSON.stringify(subtasks));
            
            console.log('ğŸ“‹ FormData creado:');
            for (let [key, value] of formData.entries()) {
                console.log(`  ${key}:`, value);
            }
            
            // Enviar al servidor
            fetch('?route=test-subtask-creation', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('ğŸ“¡ Response status:', response.status);
                return response.text();
            })
            .then(text => {
                console.log('ğŸ“„ Response body:', text);
                try {
                    const data = JSON.parse(text);
                    console.log('âœ… JSON parseado:', data);
                } catch (e) {
                    console.error('âŒ Error parseando JSON:', e);
                }
            })
            .catch(error => {
                console.error('ğŸ’¥ Error:', error);
            });
        }
        
        // InicializaciÃ³n
        console.log('ğŸš€ Debug de subtareas cargado');
        console.log('ğŸ“‹ Elementos disponibles:', {
            container: document.getElementById('subtasks-container'),
            template: document.getElementById('subtask-template')
        });
    </script>
</body>
</html>
